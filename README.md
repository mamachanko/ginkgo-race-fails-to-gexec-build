# Demo for [onsi/ginkgo/issues/887](https://github.com/onsi/ginkgo/issues/887)

## âœ… Tests pass without `ginkgo ... -race`
```shell
$ make test-no-race
# Recommended flags according to https://onsi.github.io/ginkgo/#recommended-continuous-integration-configuration,
# but without `-race`.
go run github.com/onsi/ginkgo/v2/ginkgo \
  -r \
  --procs=1 \
  --compilers=1 \
  --randomize-all \
  --randomize-suites \
  --fail-on-pending \
  --keep-going \
  --cover \
  --coverprofile=cover.profile \
  --trace \
  --json-report=report.json
Running Suite: GinkgoRaceFailsToGexecBuild Suite - /Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build
============================================================================================================
Random Seed: 1642846967 - will randomize all specs

Will run 1 of 1 specs
â€¢

Ran 1 of 1 Specs in 0.474 seconds
SUCCESS! -- 1 Passed | 0 Failed | 0 Pending | 0 Skipped
PASS
coverage: 0.0% of statements
composite coverage: [no statements]

Ginkgo ran 1 suite in 1.932561467s
Test Suite Passed
```

## ðŸš¨ Tests fail with `ginkgo ... -race`
```shell
$ make test
# Recommended flags according to https://onsi.github.io/ginkgo/#recommended-continuous-integration-configuration
go run github.com/onsi/ginkgo/v2/ginkgo \
  -r \
  --procs=1 \
  --compilers=1 \
  --randomize-all \
  --randomize-suites \
  --fail-on-pending \
  --keep-going \
  --cover \
  --coverprofile=cover.profile \
  --race \
  --trace \
  --json-report=report.json
Running Suite: GinkgoRaceFailsToGexecBuild Suite - /Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build
============================================================================================================
Random Seed: 1642847020 - will randomize all specs

Will run 1 of 1 specs
SIGABRT: abort
PC=0x7ff8126e2112 m=3 sigcode=0

goroutine 0 [idle]:
syscall.rawSyscall(0x10c1a80, 0x0, 0x0, 0x0)
        /usr/local/Cellar/go/1.17.5/libexec/src/runtime/sys_darwin.go:77 +0x47 fp=0xc0002076a8 sp=0xc000207688 pc=0x10a9547
syscall.rawSyscall(0x10af5e5, 0x0, 0x0, 0x1)
        <autogenerated>:1 +0x26 fp=0xc0002076f0 sp=0xc0002076a8 pc=0x10afe26
syscall.forkAndExecInChild(0xc000244120, {0xc00020a360, 0x6, 0x1}, {0xc000306000, 0x4c, 0x0}, 0x0, 0x0, 0xc0002079f8, ...)
        /usr/local/Cellar/go/1.17.5/libexec/src/syscall/exec_libc2.go:80 +0xed fp=0xc000207780 sp=0xc0002076f0 pc=0x10b9b6d
syscall.forkExec({0xc0002440c0, 0x11}, {0xc00021e050, 0x5, 0x5}, 0xc0002079f8)
        /usr/local/Cellar/go/1.17.5/libexec/src/syscall/exec_unix.go:210 +0x58f fp=0xc000207918 sp=0xc000207780 pc=0x10babef
syscall.StartProcess(...)
        /usr/local/Cellar/go/1.17.5/libexec/src/syscall/exec_unix.go:256
os.startProcess({0xc0002440c0, 0x11}, {0xc00021e050, 0x5, 0x5}, 0xc000207c88)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec_posix.go:55 +0x526 fp=0xc000207a50 sp=0xc000207918 pc=0x10ebe06
os.StartProcess({0xc0002440c0, 0x11}, {0xc00021e050, 0x5, 0x5}, 0x0)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec.go:109 +0x7a fp=0xc000207ab0 sp=0xc000207a50 pc=0x10eb7da
os/exec.(*Cmd).Start(0xc000278000)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec/exec.go:422 +0x9d4 fp=0xc000207ce0 sp=0xc000207ab0 pc=0x14cf554
os/exec.(*Cmd).Run(0xb)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec/exec.go:338 +0x31 fp=0xc000207d20 sp=0xc000207ce0 pc=0x14ceb11
os/exec.(*Cmd).CombinedOutput(0xc000278000)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec/exec.go:567 +0x20a fp=0xc000207d90 sp=0xc000207d20 pc=0x14d046a
github.com/onsi/gomega/gexec.doBuild({0xc00001e498, 0x11}, {0x1596c22, 0x36}, {0x0, 0x0, 0x0}, {0x0, 0x0, 0x0})
        /Users/mbrauer/go/pkg/mod/github.com/onsi/gomega@v1.17.0/gexec/build.go:61 +0x4dd fp=0xc000207ea8 sp=0xc000207d90 pc=0x14d4e1d
github.com/onsi/gomega/gexec.Build(...)
        /Users/mbrauer/go/pkg/mod/github.com/onsi/gomega@v1.17.0/gexec/build.go:31
github.com/mamachanko/ginkgo-race-fails-to-gexec-build_test.glob..func1()
        /Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build/ginkgo_race_fails_to_gexec_build_suite_test.go:19 +0x66 fp=0xc000207f28 sp=0xc000207ea8 pc=0x14d7686
github.com/onsi/ginkgo/v2/internal.(*Suite).runNode.func2()
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:601 +0x105 fp=0xc000207fe0 sp=0xc000207f28 pc=0x14a3c25
runtime.goexit()
        /usr/local/Cellar/go/1.17.5/libexec/src/runtime/asm_amd64.s:1581 +0x1 fp=0xc000207fe8 sp=0xc000207fe0 pc=0x10ac9a1
created by github.com/onsi/ginkgo/v2/internal.(*Suite).runNode
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:589 +0xa25

goroutine 36 [running]:
runtime.systemstack_switch()
        /usr/local/Cellar/go/1.17.5/libexec/src/runtime/asm_amd64.s:350 fp=0xc000207658 sp=0xc000207650 pc=0x10aa760
runtime.libcCall(0x18, 0xc000062900)
        /usr/local/Cellar/go/1.17.5/libexec/src/runtime/sys_libc.go:49 +0x66 fp=0xc000207688 sp=0xc000207658 pc=0x1098866
syscall.rawSyscall(0x10c1a80, 0x0, 0x0, 0x0)
        /usr/local/Cellar/go/1.17.5/libexec/src/runtime/sys_darwin.go:77 +0x47 fp=0xc0002076a8 sp=0xc000207688 pc=0x10a9547
syscall.rawSyscall(0x10af5e5, 0x0, 0x0, 0x1)
        <autogenerated>:1 +0x26 fp=0xc0002076f0 sp=0xc0002076a8 pc=0x10afe26
syscall.forkAndExecInChild(0xc000244120, {0xc00020a360, 0x6, 0x1}, {0xc000306000, 0x4c, 0x0}, 0x0, 0x0, 0xc0002079f8, ...)
        /usr/local/Cellar/go/1.17.5/libexec/src/syscall/exec_libc2.go:80 +0xed fp=0xc000207780 sp=0xc0002076f0 pc=0x10b9b6d
syscall.forkExec({0xc0002440c0, 0x11}, {0xc00021e050, 0x5, 0x5}, 0xc0002079f8)
        /usr/local/Cellar/go/1.17.5/libexec/src/syscall/exec_unix.go:210 +0x58f fp=0xc000207918 sp=0xc000207780 pc=0x10babef
syscall.StartProcess(...)
        /usr/local/Cellar/go/1.17.5/libexec/src/syscall/exec_unix.go:256
os.startProcess({0xc0002440c0, 0x11}, {0xc00021e050, 0x5, 0x5}, 0xc000207c88)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec_posix.go:55 +0x526 fp=0xc000207a50 sp=0xc000207918 pc=0x10ebe06
os.StartProcess({0xc0002440c0, 0x11}, {0xc00021e050, 0x5, 0x5}, 0x0)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec.go:109 +0x7a fp=0xc000207ab0 sp=0xc000207a50 pc=0x10eb7da
os/exec.(*Cmd).Start(0xc000278000)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec/exec.go:422 +0x9d4 fp=0xc000207ce0 sp=0xc000207ab0 pc=0x14cf554
os/exec.(*Cmd).Run(0xb)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec/exec.go:338 +0x31 fp=0xc000207d20 sp=0xc000207ce0 pc=0x14ceb11
os/exec.(*Cmd).CombinedOutput(0xc000278000)
        /usr/local/Cellar/go/1.17.5/libexec/src/os/exec/exec.go:567 +0x20a fp=0xc000207d90 sp=0xc000207d20 pc=0x14d046a
github.com/onsi/gomega/gexec.doBuild({0xc00001e498, 0x11}, {0x1596c22, 0x36}, {0x0, 0x0, 0x0}, {0x0, 0x0, 0x0})
        /Users/mbrauer/go/pkg/mod/github.com/onsi/gomega@v1.17.0/gexec/build.go:61 +0x4dd fp=0xc000207ea8 sp=0xc000207d90 pc=0x14d4e1d
github.com/onsi/gomega/gexec.Build(...)
        /Users/mbrauer/go/pkg/mod/github.com/onsi/gomega@v1.17.0/gexec/build.go:31
github.com/mamachanko/ginkgo-race-fails-to-gexec-build_test.glob..func1()
        /Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build/ginkgo_race_fails_to_gexec_build_suite_test.go:19 +0x66 fp=0xc000207f28 sp=0xc000207ea8 pc=0x14d7686
github.com/onsi/ginkgo/v2/internal.(*Suite).runNode.func2()
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:601 +0x105 fp=0xc000207fe0 sp=0xc000207f28 pc=0x14a3c25
runtime.goexit()
        /usr/local/Cellar/go/1.17.5/libexec/src/runtime/asm_amd64.s:1581 +0x1 fp=0xc000207fe8 sp=0xc000207fe0 pc=0x10ac9a1
created by github.com/onsi/ginkgo/v2/internal.(*Suite).runNode
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:589 +0xa25

goroutine 1 [chan receive]:
testing.(*T).Run(0xc000001ba0, {0x158d091, 0x1f}, 0x15a5af0)
        /usr/local/Cellar/go/1.17.5/libexec/src/testing/testing.go:1307 +0x752
testing.runTests.func1(0x0)
        /usr/local/Cellar/go/1.17.5/libexec/src/testing/testing.go:1598 +0x9a
testing.tRunner(0xc000001ba0, 0xc000171bc0)
        /usr/local/Cellar/go/1.17.5/libexec/src/testing/testing.go:1259 +0x230
testing.runTests(0xc000030580, {0x18afb40, 0x1, 0x1}, {0x0, 0xc0000975c0, 0x0})
        /usr/local/Cellar/go/1.17.5/libexec/src/testing/testing.go:1596 +0x7cb
testing.(*M).Run(0xc000030580)
        /usr/local/Cellar/go/1.17.5/libexec/src/testing/testing.go:1504 +0x9d2
main.main()
        _testmain.go:93 +0x325

goroutine 3 [select]:
github.com/onsi/ginkgo/v2/internal.(*Suite).runNode(_, {0x1, 0x200, {0x0, 0x0}, 0x15a5af8, {{0x16b5850, 0x68}, 0x11, {0x0, ...}, ...}, ...}, ...)
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:605 +0xab1
github.com/onsi/ginkgo/v2/internal.(*Suite).runSuiteNode(0xc00009a000, {0x1, 0x200, {0x0, 0x0}, 0x15a5af8, {{0x16b5850, 0x68}, 0x11, {0x0, ...}, ...}, ...}, ...)
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:445 +0xeac
github.com/onsi/ginkgo/v2/internal.(*Suite).runBeforeSuite(0xc00009a000, 0x1)
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:340 +0x3c8
github.com/onsi/ginkgo/v2/internal.(*Suite).runSpecs(0xc00009a000, {0x158e202, 0x21}, {0x19082a0, 0x0, 0x0}, {0xc0000180c4, 0x39}, 0x0, {0xc000210060, ...})
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:270 +0x46d
github.com/onsi/ginkgo/v2/internal.(*Suite).Run(_, {_, _}, {_, _, _}, {_, _}, _, {0x162dde0, ...}, ...)
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/suite.go:83 +0x425
github.com/onsi/ginkgo/v2.RunSpecs({0x1624ee0, 0xc000001d40}, {0x158e202, 0x21}, {0x0, 0x0, 0x0})
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/core_dsl.go:280 +0x1045
github.com/mamachanko/ginkgo-race-fails-to-gexec-build_test.TestGinkgoRaceFailsToGexecBuild(0x0)
        /Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build/ginkgo_race_fails_to_gexec_build_suite_test.go:12 +0xeb
testing.tRunner(0xc000001d40, 0x15a5af0)
        /usr/local/Cellar/go/1.17.5/libexec/src/testing/testing.go:1259 +0x230
created by testing.(*T).Run
        /usr/local/Cellar/go/1.17.5/libexec/src/testing/testing.go:1306 +0x727

goroutine 34 [syscall]:
os/signal.signal_recv()
        /usr/local/Cellar/go/1.17.5/libexec/src/runtime/sigqueue.go:166 +0x28
os/signal.loop()
        /usr/local/Cellar/go/1.17.5/libexec/src/os/signal/signal_unix.go:24 +0x25
created by os/signal.Notify.func1.1
        /usr/local/Cellar/go/1.17.5/libexec/src/os/signal/signal.go:151 +0x53

goroutine 35 [select]:
github.com/onsi/ginkgo/v2/internal/interrupt_handler.(*InterruptHandler).registerForInterrupts.func2()
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/interrupt_handler/interrupt_handler.go:127 +0x1c5
created by github.com/onsi/ginkgo/v2/internal/interrupt_handler.(*InterruptHandler).registerForInterrupts
        /Users/mbrauer/go/pkg/mod/github.com/onsi/ginkgo/v2@v2.0.0/internal/interrupt_handler/interrupt_handler.go:122 +0x393

rax    0x0
rbx    0x700005812000
rcx    0x700005811c78
rdx    0x0
rdi    0x303
rsi    0x6
rbp    0x700005811ca0
rsp    0x700005811c78
r8     0x0
r9     0x0
r10    0x0
r11    0x246
r12    0x303
r13    0x50
r14    0x6
r15    0x16
rip    0x7ff8126e2112
rflags 0x246
cs     0x7
fs     0x0
gs     0x0
------------------------------
[BeforeSuite] [FAILED] [0.008 seconds]
[BeforeSuite]
/Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build/ginkgo_race_fails_to_gexec_build_suite_test.go:17

  Unexpected error:
      <*errors.errorString | 0xc000074d30>: {
          s: "Failed to build github.com/mamachanko/ginkgo-race-fails-to-gexec-build:\n\nError:\nexit status 2\n\nOutput:\n",
      }
      Failed to build github.com/mamachanko/ginkgo-race-fails-to-gexec-build:

      Error:
      exit status 2

      Output:

  occurred
  In [BeforeSuite] at: /Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build/ginkgo_race_fails_to_gexec_build_suite_test.go:20

  Full Stack Trace
    github.com/mamachanko/ginkgo-race-fails-to-gexec-build_test.glob..func1()
        /Users/mbrauer/workspace/ginkgo-race-fails-to-gexec-build/ginkgo_race_fails_to_gexec_build_suite_test.go:20 +0x10c
------------------------------

Ran 0 of 1 Specs in 0.010 seconds
FAIL! -- A BeforeSuite node failed so all tests were skipped.
--- FAIL: TestGinkgoRaceFailsToGexecBuild (0.01s)
FAIL
coverage: 0.0% of statements
composite coverage: [no statements]

Ginkgo ran 1 suite in 1.476381555s

Test Suite Failed
exit status 1
gmake: *** [Makefile:4: test] Error 1
```
